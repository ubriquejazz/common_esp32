<!DOCTYPE html>
<html>
<head>
    <title>Ejemplo 8</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>  
<script type="text/javascript" >
    window.onload = function () {  
        var reconnectTimeout = 2000;
        var host ="broker.emqx.io";
        var port = 8083;

        var clientId = "webio4mqttexample";
        clientId += new Date().getUTCMilliseconds();;
        var myTopic="testtopic/nodered/2";
        console.log("On load");

        // Create a client instance
        //client = new Paho.MQTT.Client(location.hostname, Number(location.port), "clientId");
        client = new Paho.MQTT.Client(host, port, clientId);

        // set callback handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // connect the client
        client.connect({onSuccess:onConnect});

        // called when the client connects
        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            console.log("onConnect");
            client.subscribe(myTopic);
         //   message = new Paho.MQTT.Message("Hello");
         //   message.destinationName = myTopic;
         //   client.send(message); 
        }

        // called when the client loses its connection
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:"+responseObject.errorMessage);
            }
            // reconnect the client
            client.connect({onSuccess:onConnect});

        }

        // called when a message arrives
        function onMessageArrived(message) {
            console.log("onMessageArrived:"+message.payloadString);
            // convierte en objeto el JSON recibido en el mensaje
            var lectura = JSON.parse(message.payloadString);
            console.log("Temp = " + lectura.temperatura);
            console.log("Iluminacion = " + lectura.iluminacion);
            // actualiza los objetos de visualización en función de las variables
            updateTemperature(lectura.temperatura); 
            updateIluminacion(lectura.iluminacion); 
            updateCanvas(lectura.temperatura, lectura.iluminacion);
        }        
    } 
    // actualiza el valor de la temperatura en el código HTML
    function updateTemperature(temperatura){
        document.getElementById("temperatura").innerHTML = temperatura + " &ordm;C";
        color_R=(temperatura/100.0)*255;
        color_B=((100.0-temperatura)/100)*255;
        document.getElementById("temp").style.backgroundColor = "rgb("+color_R+",0,"+color_B+")";
        document.getElementById("temp").style.width=""+temperatura+"px";
    }
    // actualiza el valor de la iluminación en el código HTML
    function updateIluminacion(iluminacion){
        document.getElementById("iluminacion").innerHTML = iluminacion + " lux";
        document.getElementById("ilu").style.backgroundColor = "hsl(50, " + iluminacion + "%, 49%)";
    }
</script>
<body>
    <h1>Lectura de sensores</h1>
    <table>
        <tr>
            <td>Temperatura:</td>
            <td  id="temperatura">27 &ordm;C</td>
            <td>
                <table>
                    <tr><td id="temp" style="height:10px; background-color:#FF0000">.</td></tr>
                </table>
            </td>
        </tr>
        <tr>
            <td>Iluminacion:</td>
            <td  id="iluminacion">30 lux</td>
            <td  id="ilu" style="width:200px; background-color:#00FF00"></td>
            
        </tr>
    </table>
    <h1>Visualizacion con canvas</h1>
    <canvas id="myCanvas" width="200" height="200"
            style="border:1px solid #d3d3d3;">
    </canvas>
       <script>
        function updateCanvas(temp, ilu) {
           var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");
            //Escribe el texto
            ctx.clearRect(0, 0, 200, 200);
            ctx.font = "15px Arial";
            ctx.fillText("Temperatura", 10, 30); 
            // Rectángulo con el exterior azul y la interior roja de tamaño variables
            ctx.fillStyle = "#0000FF"; 
            ctx.rect(40, 50, 100, 20);
            ctx.stroke(); 
            ctx.fillStyle = "#FF0000"; 
            ctx.fillRect(40, 50, temp, 20);
            // Escribe texto
            ctx.fillStyle = "black"; 
            ctx.font = "15px Arial";
            ctx.fillText("Iluminacion", 10, 100); 
            // Arco del indicador radial
            ctx.beginPath();
            ctx.arc(80, 150, 40, Math.PI, 2*Math.PI);
            ctx.stroke(); 
            // Almacena el origen de coordenadas y la rotación para recuperar posteriormente
            ctx.save(); 
            // Rotación proporcional a la variable
            ctx.translate(80,150);
            ctx.rotate((temp+100) * Math.PI / 100);
            // Representa la aguja
            ctx.fillStyle = "red"; 
            ctx.fillRect(30, -4, 10, 15);
            ctx.stroke(); 
            ctx.fillStyle = "black"; 
            ctx.fillRect(0, 0, 30, 4);
            ctx.stroke(); 
            // Recupera la configuración de coordenadas del canvas
            ctx.restore(); 
          }
       </script>
  </table>
 </body>
</html> 
